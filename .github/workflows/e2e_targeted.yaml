name: e2e tests (targeted)

on:
  workflow_dispatch:
    inputs:
      controller-image:
        description: 'KIC Docker image to test with. If empty, builds an image from the dispatch branch.'
        required: false
      run-gke:
        description: 'Run E2E tests on GKE as well as on Kind.'
        type: boolean
        default: false
      run-istio:
        description: 'Run Istio E2E tests.'
        type: boolean
        default: false
      all-supported-k8s-versions:
        description: 'Run tests against all supported Kubernetes versions. Otherwise, only against the latest one.'
        type: boolean
        default: false

jobs:
  build-image:
    if: ${{ inputs.controller-image == '' }}
    uses: ./.github/workflows/_docker_build.yaml
    secrets: inherit

  run:
    needs: build-image
    uses: ./.github/workflows/_e2e_tests.yaml
    secrets: inherit
    with:
      kic-image: ${{ needs.build-image.outputs.image }}
      load-local-image: ${{ inputs.controller-image == '' }}
      run-gke: ${{ inputs.run-gke }}
      run-istio: ${{ inputs.run-istio }}
      all-supported-k8s-versions: ${{ inputs.all-supported-k8s-versions }}
